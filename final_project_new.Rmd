---
title: "college_basketball"
author: "Will Curkan"
date: "11/14/2021"
output: html_document
---
WHAT IT TAKES

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(dplyr)
library(GGally)
library(ggplot2)
library(corrplot)
library(RColorBrewer)
library(stringr)
library(readxl)
library(ggrepel)
```

We took the data from a kaggle dataset.
The data is the past decade's NCAA college basketball data filtered down to the last 3 seasons 18-19,19-20,20-21 to stay recent.
Our goal was to look at data trends based on role and academic status (being freshman, sophmores, juniors, and seniors)

For simplicity we categorize all guard variations as guards, and all the Powerforwards, centers and stretch as post players.
And because we are in a new season, we will not look at senior players other than in the general graphs


```{r import data}
bb_dat = read.csv("CollegeBasketballPlayers2009-2021.csv")
school_dat = read_excel("bb_school_ranks.xlsx")

```

Cleaned data to make easier to work with:
1. rename variables to readable, workable names
2. filter to recent 3 years
3. remove less-meaningful variables
```{r data cleanup}
#create this vector to see assists for all top teams

new_bb = bb_dat %>%
  rename(role = X, player = player_name) %>%
  filter(year > 2018) %>%
  select(!ht & !dunksmade & !dunksmiss.dunksmade
         & !dunksmade..dunksmade.dunksmiss.
         & !type & !num & !pid & !pick & !pfr
         & !Rec.Rank) %>%
  mutate(top_team = ifelse(team %in% top_teams_vector,T,F))
  
son_bb_dat <- bb_dat %>%    select(-c(27,28,34,35,38,40,41,42,44,45,46,66)) %>% filter(year!=2009) %>% rename (college_year = yr, role = X)

#rename school to team to match new_bb
new_ranks = school_dat %>%
  rename(team = school) %>%
  add_count(team)%>%
  rename(appearances = n)

```

## How's relationship between all the varibles?

First , we take a look at how's relationship between all the varibles? 

```{r}
numeric_dat <- select_if(son_bb_dat,is.numeric) %>% select(-contains("per"))%>% na.omit()
corrplot(cor(numeric_dat), type="upper", order="hclust",
         col=brewer.pal(n=8, name="RdYlBu"))
```
So, we notice a couples negative correlation dbpm/dgbpm/bpm vs drtg, and pfr vs drtg and some postive correlation porpag vs adjoe & obpm, pts vs dreb/dporpag/rimmade/midmade/twoPM/FTM/mp/stops, rimmade/dreb/treb/pts, GP vs stops, stl vs mp. 


```{r}
son_bb_dat$role[son_bb_dat$role == ""] <- NA
son_bb_dat %>% na.omit()%>% filter(rimmade > 100) %>% group_by(role)%>% ggplot( aes(x= rimmade, y = pts, group = role)) +
  geom_point(aes(col=role, alpha=0.01))+
  facet_wrap(~role)
```

Creating joined frame to work with top 25 ranked schools:
```{r joined} 
#creating vector for top team in whole dataset
top_teams_vector = new_ranks$team

#recreating new_bb filter to show if player in top team
new_bb = new_bb %>%
  mutate(top_team = ifelse(team %in% top_teams_vector,T,F))

#46 teams have been in top 25 from (2018-)2019-2021
top_25s = inner_join(new_bb,new_ranks) %>%
  relocate(college_year = yr, year, role, .before = GP)


```
Sports is a teamwork!Then how to evaluate a good team player, we measure playerâ€™s contributions and their impact on the court by BPM (Box Plus/Minus). The more time they contribute on the court, the more points they get. 


```{r}
son_bb_dat $pts[son_bb_dat$pts == ""] <- NA
son_bb_dat $role[son_bb_dat$role == ""] <- NA
son_bb_dat $mp[son_bb_dat$mp == ""] <- NA
son_bb_dat %>% filter(college_year != "Sr") %>% add_count(player_name) %>% filter(n == 10) %>% na.omit() %>% ggplot(aes(x=pts,y=bpm))+ 
  geom_smooth(se = F) +  
  theme_light() + 
  xlab("Points") + ylab(" Box Plus/Minus")+ ggtitle("Box Plus/Minus vs. Points")
son_bb_dat %>% filter(college_year != "Sr") %>% add_count(player_name) %>% filter(n == 10) %>% na.omit() %>% ggplot(aes(x=pts,y=mp))+ 
  geom_smooth(se = F) +  
  theme_light() + 
  xlab("Points") + ylab(" Minutes Played")+ ggtitle("Minutes Played vs. Points")
son_bb_dat %>% filter(college_year != "Sr") %>% add_count(player_name) %>% filter(n == 10) %>% na.omit() %>% ggplot(aes(x=bpm,y=mp))+ 
  geom_smooth(se = F) +  
  theme_light() + 
  xlab("Box Plus Minus") + ylab(" Minutes Played") + ggtitle("Minutes Played vs. Box Plus/Minus")
#ggplot(aes(x = player,y = TPA, color=player)) + geom_point()
```
How each position attribute into gaining points
```{r}
son_bb_dat$role[son_bb_dat$role == ""] <- NA
son_bb_dat %>% na.omit() %>% ggplot(aes(x=role,y=pts,fill=role)) +
  geom_boxplot(aes(na.rm=T)) + theme_linedraw() + 
  xlab("Role") + ylab("Points")

son_bb_dat%>% na.omit() %>% ggplot(aes(x=role,y=pts,fill=role)) + 
  geom_boxplot(aes(x=role,
                   y=pts,
                   fill=role,
                   na.rm=T)) + 
  geom_text_repel(data = filter(son_bb_dat, pts >= 23), 
                  aes(label = player_name,
                      col=role)) + 
  theme_linedraw() +
  xlab("Role") + 
  ylab("Points")  
```
## How  academic status (freshman, sophmores, juniors, and seniors) affect their performance?

> for the AST % vs eFG by college year in top 25 teams, if we look at the upper right quadrant where players with high eFG and AST % distributed, we can see most outlier points in this quadrant are mostly freshman and sophomore.

```{r}
# Top 50 Assistant percentage  vs college year

son_bb_dat %>% slice_max(AST_per, n=50) %>% count(college_year) %>% filter(college_year == "Fr"|college_year =="So"|college_year =="Jr"|college_year =="Sr") %>% mutate(college_year = recode(college_year, "Fr"= "Freshman","So" = "Sorphomore", "Jr" = "Junior", "Sr" = "Senior")) %>% ggplot(aes(x=college_year,y = n,fill = college_year)) + geom_col()+ 
  labs(fill = "College Year\n")+
  xlab("College Year") + 
  ylab("Count")+ ggtitle("Top 50 Assistant Percentage by College Year")+theme_linedraw()

# Top 50 Effective Field Goal vs college year
son_bb_dat %>% slice_max(eFG, n=50) %>% count(college_year) %>% filter(college_year == "Fr"|college_year =="So"|college_year =="Jr"|college_year =="Sr")  %>% mutate(college_year = recode(college_year, "Fr"= "Freshman","So" = "Sorphomore", "Jr" = "Junior", "Sr" = "Senior")) %>% ggplot(aes(x=college_year,y = n,fill = college_year)) + geom_col()+ theme_linedraw() + 
  labs(fill = "College Year\n")+
  xlab("College Year") + 
  ylab("Count") + ggtitle("Top 50 Effective Field Goal by College Year")
# AST % vs eFG by college year

top_25s %>% group_by(player) %>% filter(college_year == "Fr"|college_year =="So"|college_year =="Jr"|college_year =="Sr", eFG !=0, AST_per!=0 ) %>% ggplot(aes(x=AST_per,y = eFG)) +
  geom_point(aes(color = college_year))+
  facet_wrap(~college_year)+
  labs(color = "College Year\n") +
  xlab("Assistant Percentage")+
  ylab("Effective Field Goal %") + 
  ggtitle("Assistant Percentage vs. Effective Field Goal % \n by college year") + 
  theme_minimal() 
```

## The more they contribute on the court, the more points they get ?
```{r}
son_bb_dat $pts[son_bb_dat$pts == ""] <- NA
son_bb_dat %>% na.omit() %>% ggplot(aes(x=pts,y=bpm))+
  geom_smooth(se = F) +  
  theme_light() + 
  xlab("Points") + 
  ylab("Box Plus/Minus")+ ggtitle("Relationship between  Box Plus Minus and Points")
```

## Who is the best offensive players?

```{r}
son_bb_dat $pts[son_bb_dat$pts == ""] <- NA
#Relationship between Offensive Box Plus/minus vs points
son_bb_dat $pts[son_bb_dat$pts == ""] <- NA
son_bb_dat %>% na.omit() %>% ggplot(aes(x=pts,y=obpm))+ 
  geom_smooth(se = F) +  
  theme_light() + 
  xlab("Points") + ylab(" Offensive Box Plus/Minus")+ ggtitle("Relationship between Offensive Box Plus Minus and Points")
# Offensive Rating vs Points among players have 100 % assistance percentage
son_bb_dat %>% filter(AST_per == 100, Ortg!= 0, pts!=0) %>% 
  ggplot(aes(x= Ortg, y= pts))+ 
  geom_point(aes(color=role)) + 
  geom_text_repel(hjust = 0, nudge_x = 0, 
                  aes(label= player_name, colour = role),size=2)+  
  theme_minimal()+
  xlab("Offensive Rating") + ylab("Points") + ggtitle("Offensive Rating vs. Points \n Among Players with 100 % assistance percentage")
```

## Who is best defensive player who are 
Playing great defense will lead to more offense, minimize opponents possession time and shooting percentage per possession.
Defensive Rating (DRtg)
Defensive Rebounding Percentage (DRB%)
Block Percentage (BLK%)
Steal Percentage (STL%)

```{r}
son_bb_dat %>% 
  select(1:2,role, drtg, blk_per,stl_per,DRB_per,pts) %>% 
  na.omit() %>% 
  group_by(role)%>% 
  ggplot(aes(x= drtg, y = pts, group = role)) +
  geom_point(aes(col=role, alpha=0.01))+
  facet_wrap(~role)
```

The relationship between Effective Field Goal vs Box Plus/Minus

```{r}
son_bb_dat$eFG[son_bb_dat$eFG == ""] <- NA
son_bb_dat %>% na.omit() %>% ggplot(aes(x=eFG,y=bpm))+
  geom_smooth(se = F) + 
  theme_light() + 
  xlab("Effective Field Goal") + 
  ylab("Box Plus/Minus")
```

The relationship Game played and Effective Field Goal?
Especially, Power Forward Position seem like  experience is very important to consider selecting players for this position in the dream team for a higher effective field goal
```{r}
son_bb_dat$eFG[son_bb_dat$eFG == ""] <- NA
son_bb_dat %>%  na.omit() %>% ggplot(aes(y=eFG,x=GP))+
  geom_smooth(aes(colour = role), se=F) +
  theme_classic() +
  facet_wrap(~role)+
  labs(x="Game Glayed", y="Effective Field Goal %", title="Effective Field Goal % vs. Game played \nby Role")
```

Point vs Assistance by Team in top 10 team have highest accummulated 
```{r}
top_25s %>%na.omit() %>% group_by(team) %>%
summarize(n = sum(ast), m = sum(pts)) %>%
head(10) %>%  ggplot(aes(x=n,y=m))+ 
  geom_point(aes(col = team)) +  
  geom_text(aes(label=team,col=team))+
  xlab("Assistance") +
  ylab("Points")
son_bb_dat %>%na.omit() %>% group_by(team) %>%
summarize(ast_sum = sum(ast), m = sum(pts)) %>%
slice_max(ast_sum, n = 10) %>%  ggplot(aes(x=ast_sum,y=m))+ 
  geom_point(aes(col = team)) +  
  geom_text_repel(aes(label=team,col=team))+
  labs(x="Assistance", y="Points", title="Assistance vs Points \nTop 10 Team with Highest Assistance")
  
```

1. How many teams in the NCAA

```{r NCAA intro facts}
#unique teams in NCAA n = 358, all divisions
new_bb %>%
  distinct(team) %>%
  count()

#unique players in NCAA, 8697 in 2018+
new_bb %>%
  distinct(player) %>%
  count()

#11 players appearing in all 3 seasons up to 21-22, top 25
top_25s %>%
  filter(!college_year == "Sr") %>%
  add_count(player) %>%
  filter(n == 3) %>%
  group_by(player) %>%
  summarize(n = n()) %>%
  count()
```

1.Free Throws are incredibly important because they are uncontested shots 
```{r free throws}
new_bb %>%
  # filter(FTA > 58 & FT_per > .769) %>%
  ggplot(aes(x = FTA,y = FT_per)) +
  geom_point() + 
  geom_smooth()+
  xlab("Free Throw Attempts") +
  ylab("Free Throw Percentage")+
  ggtitle("General Free Throw Comparison")

#guards
new_bb %>%
  filter(FTA > 58 & FT_per > .769) %>%
      filter(role == "Combo G" | role == "Scoring PG"
        | role == "Wing G" | role == "Pure PG") %>%
  ggplot(aes(x = FTA,y = FT_per)) +
  geom_point() + 
  geom_smooth()+
  xlab("Free Throw Attempts") +
  ylab("Free Throw Percentage")+
  ggtitle("Guard Free Throws")

#Centers/Powerforwards
new_bb %>%
  filter(FTA > 58 & FT_per > .769) %>%
  filter(role == "PF/C" | role == "C"
        | role == "Wing F" | role == "Stretch 4") %>%
  ggplot(aes(x = FTA,y = FT_per)) +
  geom_point() + 
  geom_smooth()+
  xlab("Free Throw Attempts") +
  ylab("Free Throw Percentage")+
  ggtitle("Post Player Free Throws")

quantile(new_bb$FT_per,c(.25,.5,.75))
quantile(new_bb$FTA,c(.25,.5,.75))
```

2. Rebounds are important because this is where the teams show who wnats it more, this is where the game get's physical, and personal.

```{r rebound comparison}
#maybe use density graph for this
new_bb %>%
  filter(GP > 29) %>%
  ggplot(aes(x = ORB_per,y = DRB_per)) +
  geom_point() + 
  geom_smooth()+ 
  xlab("Offensive Rebound Percentage")+
  ylab("Defensive Rebound Percentage")+
  ggtitle("Rebound Comparison")

#Guards
new_bb %>%
  filter(GP > 29 & ORB_per >= 7.6 & DRB_per >= 16.7) %>%
    filter(role == "Combo G" | role == "Scoring PG"
        | role == "Wing G" | role == "Pure PG") %>%
  filter(!yr == "Sr") %>%
  ggplot(aes(x = ORB_per,y = DRB_per, color = team)) +
  geom_point() + 
  geom_smooth()+ 
  xlab("Offensive Rebound Percentage")+
  ylab("Defensive Rebound Percentage")+
  ggtitle("Guard Rebound Comparison")

#Center/Powerforwards
new_bb %>%
  filter(GP > 29 & ORB_per >= 7.6 & DRB_per >= 16.7) %>%
  filter(role == "PF/C" | role == "C"
        | role == "Wing F" | role == "Stretch 4") %>%
  filter(!yr == "Sr") %>%
  ggplot(aes(x = ORB_per,y = DRB_per)) +
  geom_point() + 
  geom_smooth()+
  facet_wrap(~yr)+
  xlab("Offensive Rebound Percentage")+
  ylab("Defensive Rebound Percentage")+
  labs(title = "Post Player Rebound Comparison",
       subtitle = "")

quantile(new_bb$GP,c(.25,.5,.75))
quantile(new_bb$ORB_per,c(.25,.5,.75))
quantile(new_bb$DRB_per,c(.25,.5,.75))
```



```{r top 10 asts}
options(scipen = 999)
top_25s %>%
  na.omit() %>%
  filter(appearances == 3) %>%
  group_by(team) %>%
  summarize(n = sum(ast))%>%
  arrange(desc(n)) %>%
  ggplot()+
  geom_col(aes(x = team,y = n,fill = team))+
  ggtitle("Total Assist for Team with 3 appearances")+
  xlab("Team")+
  ylab("Assists")+
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())
  

some_new_bb = new_bb %>%
  filter(top_team == T) %>%
  left_join(new_ranks)

some_new_bb %>%
  group_by(team) %>%
  summarize(n_ast = mean(ast)) %>%
  left_join(some_new_bb) %>%
  na.omit() %>%
  ggplot() +
  geom_density(aes(x = n_ast, color = as.factor(appearances)))+
  ggtitle(label = "Mean Assists of All Teams \nAppearing in the top 25",
        subtitle = "independent of season rank \nfor all seasons")+
  labs(color = "Appearances in Top 25")

```

```{r ast/tov}
top_25s %>%
  na.omit() %>%
  filter(ast.tov > 1 & GP > 29) %>%
  ggplot(aes(x = GP,y = ast.tov))+
  geom_point()+
  geom_smooth()
  
```

In order to create a dream team for the 2022 season we must look at freshman in 2018-2019, freshman and sophmores in 2019-2020, and freshman, sophmore, and juniors in 2020-2021
```{r freshman 2019 filters}
#top freshman guards
top_fr_guards = top_25s %>%
  filter(college_year == 'Fr' & year == 2019 & GP > 25) %>%
  filter(role == "Combo G" | role == "Scoring PG"
        | role == "Wing G" | role == "Pure PG")


#top powerforwards and centers
top_fr_PfC = top_25s %>%
  filter(college_year == 'Fr' & year == 2019) %>%
  filter(role == "PF/C" | role == "C"
        | role == "Wing F" | role == "Stretch 4")

# corrplot(cor(cont_dat),type="upper", order="hclust",col=brewer.pal(n=8, name="RdYlBu"))
``` 

```{r freshman plots}
top_fr_guards %>% 
  select(where(is.double))
  
top_fr_guards %>%
  ggplot(aes(x = twoPA)) +
  geom_histogram()

top_fr_PfC %>%
  ggplot(aes(x = twoPA,y = twoPM)) +
  geom_violin()

top_fr_PfC %>%
  arrange(desc(DRB_per,twoP_per)) %>%
  slice(1:5) %>%
  ggplot(aes(x = DRB_per,y = twoP_per)) +
  geom_point() +
  geom_smooth() + 
  geom_text(aes(label=player))

top_fr_PfC %>%
  arrange(desc(DRB_per,twoP_per)) %>%
  slice(1:5) %>%
  ggplot(aes(x = DRB_per,y = twoP_per)) +
  geom_point() +
  geom_smooth() + 
  geom_text(aes(label=player))


#filter for top DRB percentage and shooting
top_fr_PfC %>%
  arrange(desc(DRB_per,twoP_per)) %>%
  filter(Min_per > 50)
  

```



1. Correlation between year (freshman, sophmore, etc) and stats
or recurring players and juniors
```{r}
#looking at individual recurring players stats
recurring_andJuniors = top_25s %>%
  add_count(player) %>%
  filter(college_year == "Jr" | n == 3 & GP > 20)

#use scatterplot to compare individual recurring stats maybe
recurring_players %>%
  filter(GP > 20) %>%
  ggplot(aes(x=player,y=pts)) + 
  geom_point(aes(x=player,y=pts,color=player)) + 
  theme_linedraw() +
  xlab("Role") + 
  ylab("Points") +
  scale_x_discrete(labels = paste0('p',c(1:9)))


```






```{r}
new_bb$role[new_bb$role == ""] <- NA
new_bb %>% na.omit() %>% ggplot(aes(x=role,y=pts,fill=role)) +
  geom_boxplot(aes(na.rm=T)) + theme_linedraw() + 
  xlab("Role") + ylab("Points")

new_bb  %>% na.omit() %>% ggplot(aes(x=role,y=pts,fill=role)) + 
  geom_boxplot(aes(x=role,y=pts,fill=role,na.rm=T)) + 
  geom_text_repel(data = subset(bb_dat, pts >= 26), aes(label = player_name))+theme_linedraw() +
  xlab("Role") + 
  ylab("Points") 

new_bb %>% slice_max(AST_per, n=50) %>% count(yr) %>% filter(yr == "Fr"|yr =="So"|yr =="Jr"|yr =="Sr") %>% ggplot(aes(x=yr,y = n,fill = yr)) + geom_col()+ theme_linedraw() + 
  xlab("College Year") + 
  ylab("Count")

```




