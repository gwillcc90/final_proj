---
title: "Basketball"
author: "Son Luong'code"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(dplyr)
library(GGally)
library(ggplot2)
library(corrplot)
library(RColorBrewer)
library(stringr)
library(readxl)
library(ggrepel)
```


```{r}
bb_dat <- read.csv('CollegeBasketballPlayers2009-2021.csv')
rank_data <- read_excel("bb_school_ranks.xlsx")
# full_data after cleaning the unusefull variables 
bb_dat <- bb_dat %>% select(-c(27,28,34,35,38,40,41,42,44,45,46,66)) %>% filter(year!=2009) %>% rename (college_year = yr, role = X) 
# %>% rename_with(~str_replace(., '_per',' %'))
top_25s = right_join(bb_dat,rank_data) %>% relocate(college_year , year, role,rank, .before = GP)
```



First , we take a look at how's relationship between all the varibles?
```{r}
numeric_dat <- select_if(bb_dat,is.numeric) %>% select(-contains("per"))%>% na.omit()
corrplot(cor(numeric_dat), type="upper", order="hclust",
         col=brewer.pal(n=8, name="RdYlBu"))

```
So, we see a couples negative correlation dbpm/dgbpm/bpm vs drtg, and pfr vs drtg
and then postive corralation porpag vs adjoe & obpm, 
pts vs dreb/dporpag/rimmade/midmade/twoPM/FTM/mp/stops
rimmade/dreb/treb/pts
GP vs stops
stl vs mp 





```{r}
bb_dat$role[bb_dat$role == ""] <- NA
bb_dat %>% na.omit()%>% filter(rimmade > 100) %>% group_by(role)%>% ggplot( aes(x= rimmade, y = pts, group = role)) + 
  geom_point(aes(col=role, alpha=0.01))+
  facet_wrap(~role)


```

Sports is a teamwork!Then how to evaluate a good team player, we measure playerâ€™s contributions and their impact on the court by BPM (Box Plus/Minus). 

```{r}
bb_dat $pts[bb_dat$pts == ""] <- NA
bb_dat $role[bb_dat$role == ""] <- NA

bb_dat %>% filter(college_year != "Sr") %>% add_count(player_name) %>% filter(n == 10) %>% na.omit() %>% ggplot(aes(x=pts,y=obpm))+ 
  geom_smooth(se = F) +  
  theme_light() + 
  xlab("Points") + ylab(" Offensive Box Plus/Minus")

#ggplot(aes(x = player,y = TPA, color=player)) + geom_point()

```

How each position attribute into gaining points
```{r}
bb_dat$role[bb_dat$role == ""] <- NA
bb_dat %>% na.omit() %>% ggplot(aes(x=role,y=pts,fill=role)) +
  geom_boxplot(aes(na.rm=T)) + theme_linedraw() + 
  xlab("Role") + ylab("Points")

bb_dat%>% na.omit() %>% ggplot(aes(x=role,y=pts,fill=role)) + 
  geom_boxplot(aes(x=role,y=pts,fill=role,na.rm=T)) + 
  geom_text_repel(data = filter(bb_dat, pts >= 23), aes(label = player_name,col=role)) + 
  theme_linedraw() +
  xlab("Role") + 
  ylab("Points")  

```

AST % vs eFG by college year. Should we consider Freshman and Sophomore rather than Junior and Senior fro a dream team? 

> for the AST % vs eFG by college year in top 25 teams, if we look at the upper right quadrant where players with high eFG and AST % distributed, we can see most outlier points in this quadrant are mostly freshman and sophomore.

```{r}
# Top 50 Assistant percentage  vs college year

bb_dat %>% slice_max(AST_per, n=50) %>% count(college_year) %>% filter(college_year == "Fr"|college_year =="So"|college_year =="Jr"|college_year =="Sr") %>% mutate(college_year = recode(college_year, "Fr"= "Freshman","So" = "Sorphomore", "Jr" = "Junior", "Sr" = "Senior")) %>% ggplot(aes(x=college_year,y = n,fill = college_year)) + geom_col()+ 
  labs(fill = "College Year\n")+
  xlab("College Year") + 
  ylab("Count")+ ggtitle("Top 50 Assistant Percentage by College Year")+theme_linedraw() 

# Top 50 Effective Field Goal vs college year
bb_dat %>% slice_max(eFG, n=50) %>% count(college_year) %>% filter(college_year == "Fr"|college_year =="So"|college_year =="Jr"|college_year =="Sr")  %>% mutate(college_year = recode(college_year, "Fr"= "Freshman","So" = "Sorphomore", "Jr" = "Junior", "Sr" = "Senior")) %>% ggplot(aes(x=college_year,y = n,fill = college_year)) + geom_col()+ theme_linedraw() + 
  labs(fill = "College Year\n")+
  xlab("College Year") + 
  ylab("Count") + ggtitle("Top 50 Effective Field Goal by College Year")

# AST % vs eFG by college year

top_25s %>% group_by(player_name) %>% filter(college_year == "Fr"|college_year =="So"|college_year =="Jr"|college_year =="Sr", eFG !=0, AST_per!=0 ) %>% ggplot(aes(x=AST_per,y = eFG)) +
  geom_point(aes(color = college_year))+
  facet_wrap(~college_year)+
  labs(color = "College Year\n") +
  xlab("Assistant Percentage")+
  ylab("Effective Field Goal %") + 
  ggtitle("Assistant Percentage vs. Effective Field Goal % \n by college year") + 
  theme_minimal() 
```

The more they contribute on the court, the more points they get ?
```{r}
bb_dat $pts[bb_dat$pts == ""] <- NA
bb_dat %>% na.omit() %>% ggplot(aes(x=pts,y=bpm))+
  geom_smooth(se = F) +  
  theme_light() + 
  xlab("Points") + 
  ylab("Box Plus/Minus")+ ggtitle("Relationship between  Box Plus Minus and Points")
```
Who is the best offensive player?

```{r}
bb_dat $pts[bb_dat$pts == ""] <- NA

#Relationship between Offensive Box Plus/minus vs points
bb_dat $pts[bb_dat$pts == ""] <- NA
bb_dat %>% na.omit() %>% ggplot(aes(x=pts,y=obpm))+ 
  geom_smooth(se = F) +  
  theme_light() + 
  xlab("Points") + ylab(" Offensive Box Plus/Minus")+ ggtitle("Relationship between Offensive Box Plus Minus and Points")


# Offensive Rating vs Points among players have 100 % assistance percentage
bb_dat %>% filter(AST_per == 100, Ortg!= 0, pts!=0) %>% 
  ggplot(aes(x= Ortg, y= pts))+ 
  geom_point(aes(color=role)) + 
  geom_text_repel(hjust = 0, nudge_x = 0, 
                  aes(label= player_name, colour = role),size=2)+  
  theme_minimal()+
  xlab("Offensive Rating") + ylab("Points") + ggtitle("Offensive Rating vs. Points \n Among Players with 100 % assistance percentage")
```



The relationship between Effective Field Goal vs Box Plus/Minus

```{r}
bb_dat$eFG[bb_dat$eFG == ""] <- NA
bb_dat %>% na.omit() %>% ggplot(aes(x=eFG,y=bpm))+
  geom_smooth(se = F) + 
  theme_light() + 
  xlab("Effective Field Goal") + 
  ylab("Box Plus/Minus")

```

The relationship Game played and Effective Field Goal?
Especially, Power Forward Position seem like  experience is very important to consider selecting players for this position in the dream team for a higher effective field goal
```{r}
bb_dat$eFG[bb_dat$eFG == ""] <- NA

bb_dat %>%  na.omit() %>% ggplot(aes(y=eFG,x=GP))+
  geom_smooth(aes(colour = role), se=F) +
  theme_classic() +
  facet_wrap(~role)+
  labs(x="Game Glayed", y="Effective Field Goal %", title="Effective Field Goal % vs. Game played \nby Role")
```
  
Point vs Assistance by Team in top 10 team have highest accummulated 
```{r}
top_25s %>%na.omit() %>% group_by(team) %>%
summarize(n = sum(ast), m = sum(pts)) %>%
head(10) %>%  ggplot(aes(x=n,y=m))+ 
  geom_point(aes(col = team)) +  
  geom_text(aes(label=team,col=team))+
  xlab("Assistance") +
  ylab("Points")

bb_dat %>%na.omit() %>% group_by(team) %>%
summarize(ast_sum = sum(ast), m = sum(pts)) %>%
slice_max(ast_sum, n = 10) %>%  ggplot(aes(x=ast_sum,y=m))+ 
  geom_point(aes(col = team)) +  
  geom_text_repel(aes(label=team,col=team))+
  labs(x="Assistance", y="Points", title="Assistance vs Points \nTop 10 Team with Highest Assistance")
 

```

```{r free throws}
bb_dat %>%
  filter(FTA > 58 & FT_per > .769) %>%
  ggplot(aes(x = FTA,y = FT_per)) +
  geom_point() + 
  geom_smooth()+
  xlab("Free Throw Attempts") +
  ylab("Free Throw Percentage")+
  ggtitle("General Free Throw Comparison")
#guards
bb_dat %>%
  filter(FTA > 58 & FT_per > .769) %>%
      filter(role == "Combo G" | role == "Scoring PG"
        | role == "Wing G" | role == "Pure PG") %>%
  ggplot(aes(x = FTA,y = FT_per)) +
  geom_point() + 
  geom_smooth()+
  xlab("Free Throw Attempts") +
  ylab("Free Throw Percentage")+
  ggtitle("Guard Free Throws")

#Centers/Powerforwards

bb_dat %>%
  filter(FTA > 58 & FT_per > .769) %>%
  filter(role == "PF/C" | role == "C"
        | role == "Wing F" | role == "Stretch 4") %>%
  ggplot(aes(x = FTA,y = FT_per)) +
  geom_point() + 
  geom_smooth()+
  xlab("Free Throw Attempts") +
  ylab("Free Throw Percentage")+
  ggtitle("Post Player Free Throws")
 # quantile(bb_dat$FT_per,c(.25,.5,.75))+
  #quantile(bb_dat$FTA,c(.25,.5,.75))
```
```{r rebound comparison}
bb_dat %>%
  filter(GP > 29) %>%
  ggplot(aes(x = ORB_per,y = DRB_per)) +
  geom_point() + 
  geom_smooth()+ 
  xlab("Offensive Rebound Percentage")+
  ylab("Defensive Rebound Percentage")+
  ggtitle("Rebound Comparison")
#Guards
bb_dat %>%
  filter(GP > 29) %>%
    filter(role == "Combo G" | role == "Scoring PG"
        | role == "Wing G" | role == "Pure PG") %>%
  ggplot(aes(x = ORB_per,y = DRB_per)) +
  geom_point() + 
  geom_smooth()+ 
  xlab("Offensive Rebound Percentage")+
  ylab("Defensive Rebound Percentage")+
  ggtitle("Guard Rebound Comparison")
#Center/Powerforwards
bb_dat %>%
  filter(GP > 29) %>%
  filter(role == "PF/ C" | role == "C"| role == "Wing F" | role == "Stretch 4") %>%
  ggplot(aes(x = ORB_per,y = DRB_per)) +
  geom_point() + 
  geom_smooth()+ 
  xlab("Offensive Rebound Percentage")+
  ylab("Defensive Rebound Percentage")+
  ggtitle("Post Player Rebound Comparison")
  #quantile(bb_dat$GP,c(.25,.5,.75))

```


```{r top 10 asts}
options(scipen = 999)
top_25s %>%
  na.omit() %>%
  filter(appearances == 3) %>%
  group_by(team) %>%
  summarize(n = sum(ast))%>%
  arrange(desc(n)) %>%
  ggplot()+
  geom_col(aes(x = team,y = n,fill = team))+
  ggtitle("Total Assist for Team with 3 appearances")+
  xlab("Team")+
  ylab("Assists")+
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

top_25s %>%
  na.omit() %>%
  filter(appearances == 2)%>%
  group_by(team) %>%
  summarize(n = sum(ast)) %>%
  arrange(desc(n)) %>%
  ggplot()+
  geom_col(aes(x = team,y = n,fill = team))+
  ggtitle("Total Assist for Team with 2 appearances")+
  xlab("Team")+
  ylab("Assists")+
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

top_25s %>%
  na.omit() %>%
  filter(appearances == 1) %>%
  group_by(team) %>%
  summarize(n = sum(ast))%>%
  arrange(desc(n)) %>%
  ggplot()+
  geom_density(aes(x = n,fill = team))+
  ggtitle("Total Assist for Team With 1 Appearance")+
  xlab("Team")+
  ylab("Assists")+
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())
#full graph with all 25 teams
ast_and_team = top_25s %>%
  na.omit() %>%
  group_by(team) %>%
  summarize(n = mean(ast))%>%
  arrange(desc(n)) 

ast_Nteam_rank = full_join(ast_and_team,new_ranks) %>%
  ggplot() +
  geom_density(aes(x = n, color = as.factor(appearances)))
ast_Nteam_rank
  
```

```{r}
ast_and_team = top_25s %>%
  na.omit() %>%
  group_by(school) %>%
  summarize(mean_ast = mean(ast))
rank_data %>% add_count(school)%>% rename(appearances = n) %>% full_join(ast_and_team) %>%
  ggplot() +
  geom_density(aes(x = mean_ast, color = as.factor(appearances)))

```

```{r ast/tov}
top_25s %>%
  na.omit() %>%
  filter(ast.tov > 1 & GP > 30) %>%
  ggplot(aes(x = GP,y = ast.tov))+
  geom_point()+
  geom_smooth()
  
```

In order to create a dream team for the 2022 season we must look at freshman in 2018-2019, freshman and sophmores in 2019-2020, and freshman, sophmore, and juniors in 2020-2021
```{r freshman 2019 filters}
#top freshman guards
top_fr_guards = top_25s %>%
  filter(college_year == 'Fr' & year == 2019 & GP > 25) %>%
  filter(role == "Combo G" | role == "Scoring PG"
        | role == "Wing G" | role == "Pure PG")
#top powerforwards and centers
top_fr_PfC = top_25s %>%
  filter(college_year == 'Fr' & year == 2019) %>%
  filter(role == "PF/C" | role == "C"
        | role == "Wing F" | role == "Stretch 4")
# corrplot(cor(cont_dat),type="upper", order="hclust",col=brewer.pal(n=8, name="RdYlBu"))
``` 



```{r freshman plots}
top_fr_guards %>% 
  select(where(is.double))
  
top_fr_guards %>%
  ggplot(aes(x = twoPA)) +
  geom_histogram()
top_fr_PfC %>%
  ggplot(aes(x = twoPA,y = twoPM)) +
  geom_violin()
top_fr_PfC %>%
  arrange(desc(DRB_per,twoP_per)) %>%
  slice(1:5) %>%
  ggplot(aes(x = DRB_per,y = twoP_per)) +
  geom_point() +
  geom_smooth() + 
  geom_text(aes(label=player_name))
top_fr_PfC %>%
  arrange(desc(DRB_per,twoP_per)) %>%
  slice(1:5) %>%
  ggplot(aes(x = DRB_per,y = twoP_per)) +
  geom_point() +
  geom_smooth() + 
  geom_text(aes(label=player_name))
#filter for top DRB percentage and shooting
top_fr_PfC %>%
  arrange(desc(DRB_per,twoP_per)) %>%
  filter(Min_per > 50)
  
```



```{r fresh_soph_2020 filters}
#filters for freshman and sophmores in 2018-2019 season
top_25_2soph_2020 = top_25s %>%
  filter(college_year == "Fr" & year == 2020
         |college_year == "So" & year == 2020)
#top guards
top_2soph_role_g_2020 = top_25_2soph_2020 %>%
    filter(role == "Combo G" | role == "Scoring PG"
         | role == "Wing G" | role == "Pure PG")
#top powerforwards/center
top_2soph_role_pfC_2020 = top_25_2soph_2020 %>%
      filter(role == "PF/C" | role == "C"
         | role == "Wing F" | role == "Stretch 4")
```



```{r to juniors 2021}
#freshman, sophmore, juniors in 2020-2021 season
#top guards
top_2jnr_guards = top_25s %>%
  filter(!yr == "Sr") %>%
  filter(role == "Combo G" | role == "Scoring PG"
         | role == "Wing G" | role == "Pure PG")
#top powerforwards/center
top_2jnr_PfC = top_25s %>%
  filter(!yr == "Sr") %>%
  filter(role == "PF/C" | role == "C"
         | role == "Wing F" | role == "Stretch 4")
```




1. Correlation between year (freshman, sophmore, etc) and stats
or recurring players and juniors


```{r}
#looking at individual recurring players stats
recurring_andJuniors = top_25s %>%
  add_count(player_name) %>%
  filter(college_year == "Jr" | n == 3 & GP > 20)
#use scatterplot to compare individual recurring stats maybe
recurring_players %>%
  filter(GP > 20) %>%
  ggplot(aes(x=player_name,y=pts)) + 
  geom_point(aes(x=player_name,y=pts,color=player_name)) + 
  theme_linedraw() +
  xlab("Role") + 
  ylab("Points") +
  scale_x_discrete(labels = paste0('p',c(1:9)))
```






```{r}
new_bb$role[new_bb$role == ""] <- NA
new_bb %>% na.omit() %>% ggplot(aes(x=role,y=pts,fill=role)) +
  geom_boxplot(aes(na.rm=T)) + theme_linedraw() + 
  xlab("Role") + ylab("Points")
new_bb  %>% na.omit() %>% ggplot(aes(x=role,y=pts,fill=role)) + 
  geom_boxplot(aes(x=role,y=pts,fill=role,na.rm=T)) + 
  geom_text_repel(data = subset(bb_dat, pts >= 26), aes(label = player_name))+theme_linedraw() +
  xlab("Role") + 
  ylab("Points") 
new_bb %>% slice_max(AST_per, n=50) %>% count(yr) %>% filter(yr == "Fr"|yr =="So"|yr =="Jr"|yr =="Sr") %>% ggplot(aes(x=yr,y = n,fill = yr)) + geom_col()+ theme_linedraw() + 
  xlab("College Year") + 
  ylab("Count")
```


```{r freshman plots}
#looking at freshman playing most games and scoring highest
top_25_fr_2019 %>%
  filter(GP > 20 & Min_per > 50) %>%
  ggplot(aes(x = twoP_per,y = TP_per)) + 
  geom_point() + 
  geom_text(aes(label = player_name),size = 4,ljust = .25)

top_fr_role_g %>%
  filter(Min_per > 59.9 & AST_per > 20 ) %>%
  ggplot(aes(x = twoP_per,y = TP_per)) + 
  geom_point() + 
  geom_text(aes(label = player),size = 4,ljust = .25)
```

3. Correlation between position and points scored(barplot) group-by(team), facet year
4. Correlation between rebounds(offense and def) position, and points scored (continuous)
```{r}
top_25s %>%
filter(year == 2020) %>%
  ggplot(aes(x = team,y = FTA)) +
  geom_bar()
  
```

5. Look at averages for all players and see which freshman stick out
6. filter players not appearing in latter years
7. Look at who improves throughout the years
filter for players who only play to junior year