---
title: "What It Takes"
subtitle: "to Play NCAA College Basketball"
author: "Will Curkan and Son Luong"
date: "12/06/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction and Exploring Data

Sport analytics can be applied in order to discover "hidden" talent, rate players, judge players' performance, rank top teams, anticipate opponent behavior, address sport cliches, maintain integrity, and so on. By looking at valuable and meaningful sets of variables, we gain knowledge behind those numbers and trends. 

In this project, we work on the College Basketball created by Aditya Kumar from Kaggle, which contains the past decade's NCAA college basketball data. The graphs compare by role, team, and academic status. The role split is guards and posts, where guards are Combo Guard, Scoring Point Guard, Pure Point Guard, and Wing Guard, and posts are Powerforward/Center, Center, Stretch 4, and Wing Forward. Academic status splits by the standard Freshman through Senior titles. Our goal is to categorically evaluate the trends in player performance via continuous and discrete variables.

This approach helps us navigate which variables to look at and evaluate good players in different roles, as well as how player's performance is defined, and  whether academic status affects performance.

<<<<<<< HEAD
## Packages Required

```{r, message = F, warning = F}
library(tidyverse) # multiple tidy up data packages 
library(dplyr) # for data manipulation
library(ggplot2) # used for data visualization
library(corrplot) # usef for creating correlation matrix
library(RColorBrewer) #Creates nice looking color palettes especially for correlation maps
library(stringr) # 
library(readxl) #used for reading the excel file
library(ggrepel) # used to repel overlapping text labels 
library(ggpubr)
```

## Import Data & Preparation
__Data Sources__

__1) College Basketball 2009-2021 + NBA Advanced Stats__
 https://www.kaggle.com/adityak2003/college-basketball-players-20092021/metadata

We sourced this dataset from Kaggle,  created on 11/02/2021 by Aditya Kumar, who collected from nba.com (https://www.nba.com/stats/draft/history/) and Bart Torvik's blog (https://barttorvik.com/) 
 The dataset includes 66 variables.
Variable names:

__2) Top 25 College Basketball Team__
This is created by Will Curkan, who sourced the top 25 teams list from the final week of each regular season, all of which are logged on Wikipedia but sourced from the now archived corresponding year's AP poll.

https://en.wikipedia.org/wiki/2018%E2%80%9319_NCAA_Division_I_men%27s_basketball_rankings

https://en.wikipedia.org/wiki/2019%E2%80%9320_NCAA_Division_I_men%27s_basketball_rankings

https://en.wikipedia.org/wiki/2020%E2%80%9321_NCAA_Division_I_men%27s_basketball_rankings

https://collegebasketball.ap.org/poll/2019/20


```{r import data, echo = F}
bb_dat = read.csv("CollegeBasketballPlayers2009-2021.csv")
school_dat = read_excel("bb_school_ranks.xlsx")
```

First, we cleaned data to make it easier to work with by renaming some of the important variables to something readable and easy to work on, also we decided to remove less-meaningful variables and variables with a great deal of data missing.

We have two main dataframes. First, we have a full data through 2010-2021, 2009 has too much data missing. Second, we have a data frame that filters to the past 3 seasons. The third dataframe defining the top 25 teams over the past 3 seasons is to categorize teams for further analysis.

```{r data cleanup, echo = F, message = F}
# Dataframe from 3 latest years
new_bb = bb_dat %>%
  rename(role = X, player = player_name) %>%
  filter(year > 2018) %>%
  select(!ht & !dunksmade & !dunksmiss.dunksmade
         & !dunksmade..dunksmade.dunksmiss.
         & !type & !num & !pid & !pick & !pfr
         & !Rec.Rank)
# Dataframe from 2010-2021 ( take out 2009 because of too much data missing)
full_bb <- bb_dat %>% select(-c(27,28,34,35,38,40,41,42,44,45,46,66)) %>% filter(year!=2009) %>% rename (college_year = yr, role = X) 
#rename school to team to match new_bb, add frequency of team as their appearances 
new_ranks = school_dat %>%
  rename(team = school) %>%
  add_count(team)%>%
  rename(appearances = n)
#creating vector for top team in whole dataset
top_teams_vector = new_ranks$team
#recreating new_bb filter to show if player in top team
new_bb = new_bb %>%
  mutate(top_team = ifelse(team %in% top_teams_vector,T,F))
#46 teams have been in top 25 from (2018-)2019-2021
top_25s = inner_join(new_bb,new_ranks) %>%
  relocate(college_year = yr, year, role, .before = GP)
```


## Fun Fax

The whole dataset represents 362 teams, but the most recent 3 season only represents 358 teams.

```{r echo = F}
full_bb %>%
  distinct(team) %>%
  count() %>%
  rename(all_years = n)
new_bb %>%
  distinct(team) %>%
  count() %>%
  rename(x2018up = n)
```


Over the past decade, around 24000 players make up NCAA college basketball, 8700 of which were still playing until the season change.

```{r echo = F}
full_bb %>%
  distinct(player_name) %>%
  count() %>%
  rename(all_years = n)
new_bb %>%
  distinct(player) %>%
  count() %>%
  rename(x2018up = n)
```

There are only 11 players, not including seniors, who could move on to play in this current season of the NCAA with the criteria that they played as a Freshman and are going into their senior year. Balancing the stress of high-level basketball and academic success must be difficult for many students. Some skilled students also proceed to the NBA     after a shortened college career.


```{r echo = F}
top_25s %>%
  filter(!college_year == "Sr") %>%
  add_count(player) %>%
  filter(n == 3) %>%
  group_by(player) %>%
  summarize(n = n()) %>%
  count() %>%
  rename(recurring_players = n)
```

For those approaching this dataset while knowing little about Basketball, using a correlation map is a good way to form ideas of relationships or correlations between all the varibles. Consequently, we research the meaning behind these correlations, then visualize the data to explore the meanings.


```{r fig.height = 5, fig.width = 7, echo = F}
numeric_dat <- select_if(full_bb,is.numeric) %>% select(-contains("per"))%>% na.omit()
corrplot(cor(numeric_dat), type="upper", order="hclust",
         col=brewer.pal(n=8, name="RdYlBu"))
```


Notice a couples negative correlations in Defensive Box plus/Minus vs Defensive Ratings and some positive correlation Points vs Minutes Played, Defensive Rebound vs. Offensive Rebound, Free Throw Attempts vs Free Throw Percentage. We will have a closer look by visualizing these relationship later in this project.


## Visualization

Sports require teamwork! In evaluating a good team player, we measure playerâ€™s contributions and their impact on the court by BPM (Box Plus/Minus), where a 0 value is an average player. Shown in the first graph, there is a linear relationship between Minute Play and Points, the more time player perform on the court, the more chances to score. 
The second graph shows a correlation between BPM and Points: it is obvious that the more time on the court, the scoring attempts they get. However, more time on the court does not prove contribution to team performance in terms of point because an average of 15+ points is outlier-ish for all roles.
The third graph is almost philosophical in nature. Individuals not playing at least 20 minutes have a negative BPM and do not adequately contribute to the team morale. Players that have a 0 BPM are not pinned to minutes defining their worth, and constitutes players with decent overall stats.

```{r echo = F, message = F, warning = F, fig.height = 3, fig.width = 12}
full_bb $pts[full_bb$pts == ""] <- NA
full_bb $role[full_bb$role == ""] <- NA
full_bb $mp[full_bb$mp == ""] <- NA
a = full_bb %>% filter(college_year != "Sr") %>% add_count(player_name) %>% filter(n == 10) %>% na.omit() %>% ggplot(aes(x=pts,y=bpm))+ 
  geom_smooth(se = F) +  
  theme_light() + 
  xlab("Points") + ylab(" Box Plus/Minus")+ ggtitle("Box Plus/Minus vs. Points")
b = full_bb %>% filter(college_year != "Sr") %>% add_count(player_name) %>% filter(n == 10) %>% na.omit() %>% ggplot(aes(x=pts,y=mp))+ 
  geom_smooth(se = F) +  
  theme_light() + 
  xlab("Points") + ylab(" Minutes Played")+ ggtitle("Minutes Played vs. Points")
c = full_bb %>% filter(college_year != "Sr") %>% add_count(player_name) %>% filter(n == 10) %>% na.omit() %>% ggplot(aes(x=bpm,y=mp))+ 
  geom_smooth(se = F) +  
  theme_light() + 
  xlab("Box Plus Minus") + ylab(" Minutes Played") + ggtitle("MP vs. Box Plus/Minus")
ggarrange(b,a,c, ncol = 3, nrow = 1)
```


This graph shows that guards, on average, are scoring the most points, though they have the most variation of range in points scored. The outlier guards are averaging closer to 25 points, while the outlier posts are doing well to average 15.


```{r message = F, warning = F, echo = F, fig.height= 3, fig.width = 7}
full_bb %>% na.omit() %>% ggplot(aes(x=role,y=pts,fill=role)) + 
  geom_boxplot(aes(x=role,
                   y=pts,
                   fill=role)) + 
  geom_text_repel(data = filter(full_bb, pts >= 22), 
                  aes(label = player_name,
                      col=role),size = 2) + 
  theme_linedraw() +
  xlab("Role") +
  ylab("Points") +
  ggtitle("How Points Gained Differently by Roles")
```



The left graph shows that freshman are getting the highest amount of assists. Why is this? The intimidation of high-level basketball could play a factor, or they're more trusting of their veteran teammates. Either way, the trend shows that the higher your academic status, the less you pass the ball. Freshman also top the list concerning effective field goal percentage, likely because they take less shots, overall and frequently pass the ball.

```{r echo = F, fig.height = 3, fig.width = 7}
# Top 50 Highest Assists Percentage  vs College Year
d = full_bb %>% slice_max(AST_per, n=50) %>% count(college_year) %>% filter(college_year == "Fr"|college_year =="So"|college_year =="Jr"|college_year =="Sr") %>% mutate(college_year = recode(college_year, "Fr"= "Freshman","So" = "Sorphomore", "Jr" = "Junior", "Sr" = "Senior")) %>% ggplot(aes(x=college_year,y = n,fill = college_year)) + geom_col()+ 
  labs(fill = "College Year\n")+
  xlab("College Year") + 
  ylab("Count")+ ggtitle("Top 50 Assists Percentage by College Year")+theme_linedraw() 
# Top 50 Highest Effective Field Goal % vs college year
e = full_bb %>% slice_max(eFG, n=50) %>% count(college_year) %>% filter(college_year == "Fr"|college_year =="So"|college_year =="Jr"|college_year =="Sr") %>% mutate(college_year = recode(college_year, "Fr"= "Freshman","So" = "Sorphomore", "Jr" = "Junior", "Sr" = "Senior")) %>% ggplot(aes(x=college_year,y = n,fill = college_year)) + geom_col()+ theme_linedraw() + 
  labs(fill = "College Year\n")+
  xlab("College Year") + 
  ylab("Count") + ggtitle("Top 50 Highest Effective Field Goal % by College Year")
ggarrange(d,e, ncol = 2, nrow = 1)
```


The data comparing the variables Games Played (GP) and Effective Field Goal (eFG) is typical, but note that the Center and Powerforward position starts with a significantly lower eFG than other roles. The unobserved factors in post players' lacking eFG is personal, titanic heights and weights which should outclass every other position on the team and make their defensive presence indespensable. The Stretch 4 is a role-variable position, categorized as post, but scores consistently enough to be a guard. The graph also proves, in general, that individuals with better eFG will play more games. 


```{r message = F, warning=F, echo = F, fig.width = 7, fig.height = 3}
full_bb$eFG[full_bb$eFG == ""] <- NA
full_bb %>%  na.omit() %>% ggplot(aes(y=eFG,x=GP))+
  geom_smooth(aes(colour = role), se=F) +
  theme_classic() +
  facet_wrap(~role)+
  labs(x="Game Glayed", y="Effective Field Goal %", title="Effective Field Goal % vs. Game played \nby Role")
```


## Free Throws

Free Throws are one of the most important statistics to basketball players: consistently scoring during uncontested plays is important to any sport. This dataset shows that the average for free throws is 75% in high level basketball. The best scorers in free throws, however, score 5-7% more than the average where guards are the superior scorer.

```{r free throws, echo = F, message = F}
# quantile(new_bb$FT_per,c(.25,.5,.75))
# quantile(new_bb$FTA,c(.25,.5,.75))
new_bb %>%
  # filter(FTA > 58 & FT_per > .769) %>%
  ggplot(aes(x = FTA,y = FT_per)) +
  geom_point() + 
  geom_smooth()+
  xlab("Free Throw Attempts") +
  ylab("Free Throw Percentage")+
  ggtitle(label = "General Free Throw",
          subtitle = "all players")
#guards
new_bb %>%
  filter(FTA > 58 & FT_per > .769) %>%
      filter(role == "Combo G" | role == "Scoring PG"
        | role == "Wing G" | role == "Pure PG") %>%
  ggplot(aes(x = FTA,y = FT_per)) +
  geom_point() + 
  geom_smooth()+
  xlab("Free Throw Attempts") +
  ylab("Free Throw Percentage")+
  ggtitle("Guard Free Throws")+
  labs(caption="top 25%")

```

```{r  echo = F, message = F}
#Centers/Powerforwards
new_bb %>%
  filter(FTA > 58 & FT_per > .769) %>%
  filter(role == "PF/C" | role == "C"
        | role == "Wing F" | role == "Stretch 4") %>%
  ggplot(aes(x = FTA,y = FT_per)) +
  geom_point() + 
  geom_smooth()+
  xlab("Free Throw Attempts") +
  ylab("Free Throw Percentage")+
  ggtitle("Post Player Free Throws")+
  labs(caption="top 25%")

#guard with most Free throws and highest percentage
#Deishuan Booker

new_bb %>%
  filter(FTA > 250 & FT_per > .9) %>%
  select(player, team, role, TP_per, twoP_per)
```

## Rebounds

Rebounding is where the game can get physical and personal. The graphs show that post players inherently rebound more than guard players and that there is little difference among academic status and this stat. The hope was that previous experience in the NCAA would show older, experienced teammates to prioritize second-chance shots, which was disproved. 


```{r rebound comparison, echo = F, message = F, fig.height = 3, fig.width = 7}
# quantile(new_bb$GP,c(.25,.5,.75))
# quantile(new_bb$ORB_per,c(.25,.5,.75))
# quantile(new_bb$DRB_per,c(.25,.5,.75))

r1 = new_bb %>%
  filter(GP > 29) %>%
  ggplot(aes(x = ORB_per,y = DRB_per)) +
  geom_point() + 
  geom_smooth()+ 
  xlab("Offensive Rebound Percentage")+
  ylab("Defensive Rebound Percentage")+
  ggtitle(label = "Rebound Comparison",
          subtitle = "All Players")

#Center/Powerforwards
r2 = new_bb %>%
  filter(GP > 29 & ORB_per >= 7.6 & DRB_per >= 16.7) %>%
  filter(role == "PF/C" | role == "C"
        | role == "Wing F" | role == "Stretch 4") %>%
  ggplot(aes(x = ORB_per,y = DRB_per)) +
  geom_point() + 
  geom_smooth()+
  facet_wrap(~yr)+
  xlab("Offensive Rebound Percentage")+
  ylab("Defensive Rebound Percentage")+
  labs(title = "Post Player Rebounds",
       caption = "top 25%")


ggarrange(r1,r2, ncol = 2, nrow = 1)
```


```{r  echo = F, message = F, fig.height = 3, fig.width = 7}
#Guards
new_bb %>%
  filter(GP > 29 & ORB_per >= 7.6 & DRB_per >= 16.7) %>%
    filter(role == "Combo G" | role == "Scoring PG"
        | role == "Wing G" | role == "Pure PG") %>%
  select(player,team,yr,year)
```



## Assists

The data shows that there is a direct positive correlation between assists and points, because of the fact that a point must be scored to get an assist, though a score does not mean an assist was given. Though not graphed, score might not correlate with ranking because only a few of the teams with top assists and points are seen within the recent top 25 teams. Hence, assists and points themselves do not make for good individual players or teams. The assist-specific graphs show that consistent teams must have a higher average; this proves that teams should have consistent individuals throughout multiple seasons instead of relying on scoring or a superstar player, alone. 


```{r echo = F, fig.width = 7, fig.height = 3, message = F, warning=F}
ast1 = full_bb %>%
  group_by(team) %>%
summarize(ast_sum = sum(ast)
          , m = sum(pts)) %>%
  ggplot(aes(x=ast_sum,y=m))+ 
  geom_jitter()+
  labs(x="Assists", y="Points", title="The Relationship between Assists vs Points")
ast2 = full_bb %>%na.omit() %>%
  group_by(team) %>%
summarize(ast_sum = sum(ast)
          , m = sum(pts)) %>%
slice_max(ast_sum, n = 10) %>%
  ggplot(aes(x=ast_sum,y=m))+ 
  geom_point(aes(col = team)) +  
  geom_text_repel(aes(label=team,col=team))+
  labs(x="Assists", y="Points", title="Assists vs Points \nTop 10 Team with Highest Assists")
ggarrange(ast1,ast2, ncol = 2, nrow = 1)
```


```{r top 10 asts, echo = F, message = F, fig.height = 4, fig.width = 8, warning=F}
options(scipen = 999)
a1 = top_25s %>%
  na.omit() %>%
  filter(appearances == 3) %>%
  group_by(team) %>%
  summarize(n = sum(ast))%>%
  arrange(desc(n)) %>%
  ggplot()+
  geom_col(aes(x = team,y = n,fill = team))+
  ggtitle("Total Assist for Team with 3 appearances")+
  xlab("Team")+
  ylab("Assists")+
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())
  
some_new_bb = new_bb %>%
  filter(top_team == T) %>%
  left_join(new_ranks)
a2 = some_new_bb %>%
  group_by(team) %>%
  summarize(n_ast = mean(ast)) %>%
  left_join(some_new_bb) %>%
  na.omit() %>%
  ggplot() +
  geom_density(aes(x = n_ast, color = as.factor(appearances)))+
  ggtitle(label = "Mean Assists of All Teams Appearing in the Top 25",
        subtitle = "Independent of Season Rank For All Seasons")+
  labs(color = "Appearances in Top 25") +
  xlab("Mean Assists")+
  ylab("Team Count")
ggarrange(a1,a2, ncol = 2, nrow = 1)
#2-3 of the rank 1s for past 3 seasons appeared 3x
```


```{r echo = F, message = F, fig.height = 3, fig.width = 7, warning=F}
new_ranks %>%
  filter(rank == 1)
```


## The assist to turnover ratio 

Finally, looking at assist/turnover ratio in necessary to see trends among the top 25 teams. Apparently, the average ast/tov ratio is one to one while accounting for general turnovers that happen after shooting. The data shows that individuals ranked in the top 25 frequently average greater assist than turnovers, but recurring teams and players average slightly better; the density graph shows that teams with 3 appearances ultimately finish with individuals earning a higher ast/tov ratio.

```{r ast.tov, message = F, echo = F, fig.height = 3, fig.width = 7}
# quantile(new_bb$ast.tov,c(.25,.5,.75), na.rm = T)
at1 = new_bb %>%
  filter(GP > 29) %>%
  ggplot(aes(x = GP,y = ast.tov)) +
  geom_point() + 
  geom_smooth()+ 
  xlab("GP")+
  ylab("Assist/Turnover ratio")+
  ggtitle(label = "Rebound Comparison",
          subtitle = "All Players")
some_new_bb = new_bb %>%
  filter(top_team == T) %>%
  left_join(new_ranks) %>%
  na.omit()
at2 = some_new_bb %>%
  group_by(team) %>%
  summarize(at_tot = sum(round(ast.tov,2))) %>%
  left_join(some_new_bb) %>%
  ggplot() +
  geom_density(aes(x = at_tot, color = as.factor(appearances)))+
  ggtitle(label = "Sum of Assist/Turnover Ratio of All Teams Appearing \nin the Top 25",
        subtitle = "Independent of Season Rank For All Seasons")+
  labs(color = "Appearances in Top 25")+
  xlab("Assist/Turnover Ratio")
ggarrange(at1,at2, ncol = 2, nrow = 1)
```

## Conclusion

~~Get Buckets~~

There is a lot to learn about basketball statistics and even more data to work with. The apparent statistic in basketball is that high shot percentages are crucial to being a good player, but those with high shot percentage need to score more than 20 points a game to distinguish themselves from the others. Furthermore, people with high percentages cannot play in the top 25 teams without either scoring high, or being skilled enough to compensate in other critical statistics like rebounding. Contrasting individuals with team efforts: being a high-tier teammate is about much more than personal score, and more about ball handling and control statistics like assists and turnover ratios.


## References

We used the source https://www.breakthroughbasketball.com/stats/how-we-use-stats-Hagness.html to ask some questions about what this website considers important stats in the game.

We got the data about NCAA college basketball in the years 2009 - 2021 from https://www.kaggle.com/adityak2003/college-basketball-players-20092021/metadata who took data from https://barttorvik.com/
